<!DOCTYPE html>
<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
        integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>


    <link rel="stylesheet" type="text/css"
        href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400italic,600italic,700italic,200,300,400,600,700,900">
    <link rel="stylesheet" type="text/css" href="https://refreshless.com/nouislider/dist/nouislider.css">
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-queue/3.0.7/d3-queue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.0/topojson.min.js"></script>
    <script src="https://refreshless.com/nouislider/dist/nouislider.js"></script>
    <style>
        .continent {
            fill: #f0e4dd;
            stroke: #e0cabc;
            stroke-width: 0.5;
        }

        .circles {
            fill: #3c373d;
        }

        .labels {
            font-family: sans-serif;
            font-size: 11px;
            fill: #3c373d;
        }

        .tooltip {
            position: absolute;
            padding: 7px;
            font-size: 0.9em;
            pointer-events: none;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            z-index: 999;

            -moz-box-shadow: 3px 3px 10px 0px rgba(0, 0, 0, 0.25);
            -webkit-box-shadow: 3px 3px 10px 0px rgba(0, 0, 0, 0.25);
            box-shadow: 3px 3px 10px 0px rgba(0, 0, 0, 0.25);
        }

        .tooltip p {
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <div id="slider"></div>
    <button type="button" id="refresh">Refresh map</button>
    <div id="container" class="svg-container"></div>

    <script type="text/javascript">
        var slider = document.getElementById('slider');
        noUiSlider.create(slider, {
            start: [1908, 2009],
            connect: true,
            range: {
                'min': 1908,
                'max': 2009
            }
        });
        var w = 1400;
        var h = 1000;
        var width = w;
        var height = h;
        var initialData;

        var svg = d3.select("div#container").append("svg").attr("preserveAspectRatio", "xMinYMin meet").style("background-color", "#c9e8fd")
            .attr("viewBox", "0 0 " + w + " " + h)
            .classed("svg-content", true);
        var projection = d3.geo.mercator().translate([w / 2, h / 2]).scale(200).center([0, 40]);
        var path = d3.geo.path().projection(projection);

        // var tooltip = d3.select("body").append("div")
        //     .attr("class", "tooltip")
        //     .attr("opacity", 0);



        d3.json("countries.geojson", function (values) {
            svg.selectAll("path")
                .data(values.features)
                .enter()
                .append("path")
                .attr("class", "continent")
                .attr("d", path);

            d3.csv("dataset_enhanced.csv", function (csv) {
                initialData = csv;
                drawAllData();
                drawFilteredData(1908, 2009);
            });
        });


        function drawAllData() {
            var alldata = svg.selectAll("circle")
                .data(initialData)
                .enter()
                .append("circle")
                .attr("cx", function (d) {
                    return projection([d.Lon, d.Lat])[0];
                })
                .attr("cy", function (d) {
                    return projection([d.Lon, d.Lat])[1];
                })
                .attr("r", 2)
                .attr("class", "alldata");
        };

        function drawFilteredData(minYear, maxYear) {
            d3.selectAll(".filtered")
                .remove();

            var filteredData = initialData.filter(function (d) {
                return d.Year >= minYear && d.Year <= maxYear;
            });

            var filtered = svg.selectAll(".filtered")
                .data(filteredData)
                .enter()
                .append("circle")
                .attr("cx", function (d) {
                    return projection([d.Lon, d.Lat])[0];
                })
                .attr("cy", function (d) {
                    return projection([d.Lon, d.Lat])[1];
                })
                .attr("r", 4)
                .attr("fill", "red")
                .attr("class", "filtered");

            // filtered
            //     .on("mouseover", function (d) {
            //         console.log("Inside handler");
            //         console.log(d3.mouse)
            //         console.log(d3.event.pageY)
            //         // var rect = d.target.getBoundingClientRect();
            //         console.log(this);
            //         var xPosition = d3.mouse(this)[0] - 15;
            //         var yPosition = d3.mouse(this)[1] - 25;

            //         tooltip.transition()
            //             .duration(250)
            //             .attr("opacity", 1)
            //             .attr("transform", "translate(" + xPosition + "," + yPosition + ")");

            //         tooltip.html(
            //             "<p><strong>" + d.Summary + "</strong></p>"
            //         )
            //             .attr("left", (0) + "px")
            //             .attr("top", (0) + "px");
            //     })
            //     .on("mouseout", function (d) {
            //         tooltip.transition()
            //             .duration(250)
            //             .attr("opacity", 0);
            //     });
        }





        /*
        d3.select(".year").text("Year: " + selectedYear);

        var countByYear = d3.nest()
            .key(function (d) { return d.year; })
            .rollup(function (values) { return values.length; })
            .entries(filteredData);

        d3.select(".count")
            .text(function (d, i) {
                return "New Stores: " + countByYear[i].values
            });

            };*/

        var s = document.getElementById("refresh");

        s.onclick = function () {
            window.parent.window.postMessage({ message: slider.noUiSlider.get(), sender: "worldmap" }, '*');
        };

        window.addEventListener("message", (event) => {
            let [min, max] = event.data;
            drawFilteredData(Math.floor(min), Math.floor(max));
        }, false);

        // d3.select(self.frameElement).style("height", "675px");


    </script>

</body>

</html>